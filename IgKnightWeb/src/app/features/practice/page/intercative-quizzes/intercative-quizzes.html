<!-- Quiz Body -->
<div class="flex flex-1 overflow-hidden" *ngIf="!isQuizSubmitted && assignmentDetails && currentQuestion">
  <!-- Sidebar -->
  <aside class="w-64 bg-gray-900 border-r border-gray-800 p-4 flex flex-col">
    <h3 class="text-lg font-semibold mb-4">Questions</h3>

    <div class="text-sm mb-4" *ngIf="assignmentDetails">
      <span
        class="text-xs px-2 py-1 rounded-full mr-2"
        [ngClass]="difficultyMap[assignmentDetails.difficultyLevel].class"
      >
        {{ difficultyLevels[assignmentDetails.difficultyLevel] }}
      </span>
      <span>{{ technologies[assignmentDetails.technology] }}</span>
    </div>

    <!-- Question Buttons -->
    <div class="flex flex-wrap gap-2 mb-4">
      <ng-container *ngFor="let q of questions; let i = index">
        <button
          class="w-8 h-8 rounded bg-gray-800 text-white"
          [ngClass]="{
            'bg-orange-500': selectedIndex === i,
            'bg-green-600': q.answered && selectedIndex !== i
          }"
          (click)="selectQuestion(i)"
        >
          {{ i + 1 }}
        </button>
      </ng-container>
    </div>

    <!-- Legend -->
    <div class="text-xs space-y-1 text-gray-400 mb-6">
      <div><span class="inline-block w-3 h-3 bg-green-600 rounded-full mr-2"></span>Answered</div>
      <div><span class="inline-block w-3 h-3 bg-orange-500 rounded-full mr-2"></span>Current</div>
      <div><span class="inline-block w-3 h-3 bg-gray-700 rounded-full mr-2"></span>Not Answered</div>
    </div>

    <!-- Progress -->
    <div>
      <div class="text-xs mb-1">Progress</div>
      <div class="h-2 w-full bg-gray-700 rounded">
        <div class="h-2 bg-orange-500 rounded" [style.width.%]="progressPercent"></div>
      </div>
      <div class="text-xs mt-1 text-right">{{ selectedIndex + 1 }} of {{ questions.length }}</div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6 max-w-6xl mx-auto">
    <div class="w-full flex justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold">{{ assignmentDetails.title }}</h2>
      <button
        (click)="showExitQuizModal = true"
        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded shadow"
      >
        Exit Quiz
      </button>
    </div>

    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
      <div class="flex justify-between items-center mb-4 text-sm text-gray-400">
        <span>Question {{ selectedIndex + 1 }}</span>
      </div>

      <!-- Question Text -->
      <h3 class="text-lg font-bold mb-4">{{ currentQuestion.questionText }}</h3>

      <!-- Options -->
      <div class="space-y-4">
        <!-- A -->
        <div
          class="p-4 border border-gray-700 rounded cursor-pointer hover:bg-gray-800"
          [ngClass]="{ 'bg-gray-800 border-orange-500': currentQuestion.selectedOption === 0 }"
          (click)="selectOption(0)"
        >
          <span class="font-bold mr-2">A)</span> {{ currentQuestion.optionA }}
        </div>

        <!-- B -->
        <div
          class="p-4 border border-gray-700 rounded cursor-pointer hover:bg-gray-800"
          [ngClass]="{ 'bg-gray-800 border-orange-500': currentQuestion.selectedOption === 1 }"
          (click)="selectOption(1)"
        >
          <span class="font-bold mr-2">B)</span> {{ currentQuestion.optionB }}
        </div>

        <!-- C -->
        <div
          class="p-4 border border-gray-700 rounded cursor-pointer hover:bg-gray-800"
          [ngClass]="{ 'bg-gray-800 border-orange-500': currentQuestion.selectedOption === 2 }"
          (click)="selectOption(2)"
        >
          <span class="font-bold mr-2">C)</span> {{ currentQuestion.optionC }}
        </div>

        <!-- D -->
        <div
          class="p-4 border border-gray-700 rounded cursor-pointer hover:bg-gray-800"
          [ngClass]="{ 'bg-gray-800 border-orange-500': currentQuestion.selectedOption === 3 }"
          (click)="selectOption(3)"
        >
          <span class="font-bold mr-2">D)</span> {{ currentQuestion.optionD }}
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="flex justify-between items-center mt-6">
        <button
          class="px-6 py-2 rounded text-white bg-gray-700 hover:bg-orange-600 active:bg-orange-700 disabled:opacity-0 disabled:pointer-events-none"
          [disabled]="selectedIndex === 0"
          (click)="goToPrevious()"
        >
          ← Previous
        </button>

        <button
          *ngIf="selectedIndex < questions.length - 1"
          class="px-6 py-2 rounded bg-orange-600 hover:bg-orange-700 text-white"
          (click)="goToNext()"
        >
          Next →
        </button>

        <button
            *ngIf="selectedIndex === questions.length - 1"
            class="px-6 py-2 rounded bg-green-600 hover:bg-green-700 text-white disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
            (click)="submitQuiz()"
            [disabled]="!allQuestionsAnswered()"
            >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-send-horizontal">
                <path d="M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z" />
                <path d="M6 12h16" />
            </svg>
            <span>Submit Quiz</span>
            </button>
      </div>
    </div>
  </main>
</div>

<main class="flex-1 p-6 max-w-6xl mx-auto">

  <!-- Show Loading Spinner -->
  <ng-container *ngIf="!assignmentDetails || questions.length === 0 && isLoading">
    <div class="flex flex-col items-center justify-center w-full h-[70vh] text-center text-gray-400 p-6">
      <div class="animate-pulse text-xl font-semibold mb-4">Loading Quiz...</div>
      <div class="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mb-2"></div>
      <p class="text-sm">Please wait while we load your quiz.</p>
    </div>
  </ng-container>

  <!-- Show No Questions State -->
  <ng-container *ngIf="!isLoading && questions.length === 0 && assignmentDetails">
  <div class="flex flex-col items-center justify-center w-full h-[70vh] text-center text-gray-500 p-6">
    <div class="text-2xl font-semibold mb-2">No Questions Found</div>
    <p class="text-sm mb-2">It looks like there are no questions available for this assignment.</p>
    <a
      routerLink="/practice/assignments"
      class="text-sm p-2 rounded-md bg-orange-600 text-white hover:bg-orange-700"
    >
      ← Back to assignments.
    </a>
  </div>
  </ng-container>

    <!-- Quiz Result -->
<!-- Result Section -->
<ng-container *ngIf="isQuizSubmitted && attemptResult">
  <div class="text-center space-y-4">
    <!-- Result Summary Card -->
    <div class="flex justify-center">
      <div class="w-16 h-16 rounded-full bg-purple-600 flex items-center justify-center shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zap-icon lucide-zap"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg>
      </div>
    </div>
    <div class="flex justify-center flex items-center gap-3">
    <h2 class="text-3xl font-bold text-white">
        <span>{{ performanceFeedback.title }}</span></h2>
        <span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-biceps-flexed-icon lucide-biceps-flexed"><path d="M12.409 13.017A5 5 0 0 1 22 15c0 3.866-4 7-9 7-4.077 0-8.153-.82-10.371-2.462-.426-.316-.631-.832-.62-1.362C2.118 12.723 2.627 2 10 2a3 3 0 0 1 3 3 2 2 0 0 1-2 2c-1.105 0-1.64-.444-2-1"/><path d="M15 14a5 5 0 0 0-7.584 2"/><path d="M9.964 6.825C8.019 7.977 9.5 13 8 15"/></svg></span>
    </div>
    <p class="text-gray-400">{{ performanceFeedback.subtitle }}</p>

    <!-- Score Circle -->
    <div class="relative w-32 h-32 mx-auto">
      <div class="absolute inset-0 rounded-full border-[6px] border-yellow-500 animate-pulse"></div>
      <div class="absolute inset-0 flex flex-col items-center justify-center text-yellow-400 font-bold text-xl">
        {{ attemptResult.scorePercentage }}%
        <span class="text-sm text-gray-300 mt-1">
          {{ attemptResult.correctAnswers }}/{{ attemptResult.totalQuestions }} correct
        </span>
      </div>
    </div>

    <!-- Stats -->
    <div class="flex justify-center gap-6 mt-6">
      <div class="bg-slate-800 px-4 py-2 rounded-md w-32 text-white text-sm">
        <p class="text-green-400">Accuracy</p>
        <p class="text-lg font-bold">{{ attemptResult.scorePercentage }}%</p>
      </div>
      <div class="bg-slate-800 px-4 py-2 rounded-md w-32 text-white text-sm">
        <p class="text-pink-400">Questions</p>
        <p class="text-lg font-bold">{{ attemptResult.totalQuestions }}</p>
      </div>
    </div>
  </div>
  <!-- Detailed Question Review -->
  <div class="mt-10 space-y-6">
    <h3 class="text-lg text-green-400 font-bold flex items-center gap-2">
       Detailed Review
      <span class="ml-auto text-sm text-gray-400">
        {{ attemptResult.correctAnswers }}/{{ attemptResult.totalQuestions }} Correct
      </span>
    </h3>

    <div *ngFor="let review of attemptResult.questionResults; let i = index" class="bg-slate-900 rounded-lg p-4 space-y-4">
      <!-- Question Text + Correct/Incorrect -->
      <div class="flex justify-between items-center">
        <h4 class="text-white font-semibold">{{ i + 1 }}. {{ review.question }}</h4>
        <span
          class="text-sm font-medium px-2 py-1 rounded-full"
          [ngClass]="{
            'bg-green-800 text-green-300': review.isCorrect,
            'bg-red-800 text-red-300': !review.isCorrect
          }">
          {{ review.isCorrect ? 'Correct' : 'Incorrect' }}
        </span>
      </div>

      <!-- User Answer & Correct Answer -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div
          class="rounded border px-4 py-2 text-white"
          [ngClass]="{
            'border-green-500 bg-green-900': review.isCorrect,
            'border-red-500 bg-red-900': !review.isCorrect
          }">
          <p class="text-sm text-gray-400 mb-1">Your Answer</p>
          <p class="font-medium">{{ review.userAnswer }}</p>
        </div>
        <div class="rounded border px-4 py-2 text-white bg-green-900 border-green-500">
          <p class="text-sm text-gray-400 mb-1">Correct Answer</p>
          <p class="font-medium">{{ review.correctAnswer }}</p>
        </div>
      </div>

      <!-- Explanation -->
      <div class="bg-gradient-to-br from-indigo-300 to-purple-800 p-4 rounded-md text-white">
        <p class="text-sm font-semibold text-gray-800 font-bold flex items-center gap-2">
           Explanation
        </p>
            <p class="mt-1">{{ review.explanation ? review.explanation : 'No explanation' }}</p>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="flex justify-between mt-10">
    <button
      class="px-5 py-2 bg-white text-gray-800 rounded shadow hover:bg-gray-400"
      route ="/practice/assignments"
      routerLink="/practice/assignments">
      ← Back to Assignments
    </button>
    <button
      class="px-5 py-2 bg-orange-600 text-white inline-flex gap-2 rounded shadow hover:bg-orange-700"
      (click)="retakeQuiz()">
      <span><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-repeat-icon lucide-repeat"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg></span>
      <span>Retake Quiz</span>
    </button>
  </div>
</ng-container>

</main>


<!-- Exit Confirmation Modal -->
<ng-container *ngIf="showExitQuizModal">
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 space-y-4">
      <div class="flex items-start gap-4">
        <div class="mt-1 text-red-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            <path d="M10 11v6M14 11v6" />
          </svg>
        </div>
        <div class="flex-1">
          <h2 class="text-lg font-semibold text-gray-800">Exit Quiz?</h2>
          <p class="text-sm text-gray-600 mt-1">
            Are you sure you want to exit the quiz? Your progress will be lost.
          </p>
          <p class="text-sm text-red-500 mt-2">
            This action cannot be undone.
          </p>
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-2">
        <button
          class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100"
          (click)="showExitQuizModal = false"
        >
          Cancel
        </button>
        <button
          class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700"
          (click)="confirmExitQuiz()"
        >
          Yes, Exit
        </button>
      </div>
    </div>
  </div>
</ng-container>